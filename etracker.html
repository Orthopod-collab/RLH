<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Equipment Request Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f4f7fa;
      margin: 0;
      padding: 1rem;
    }
    h1 {
      text-align: center;
      color: #1a3d5d;
      margin-bottom: 1rem;
    }
    #filterInput {
      width: 250px;
      padding: 6px;
      font-size: 13px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      display: block;
      margin: 0 auto 1rem auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      padding: 6px 8px;
      border: 1px solid #ddd;
      vertical-align: middle;
    }
    th {
      background-color: #eaf0f6;
    }
    tr:nth-child(even) {
      background-color: #f9fcff;
    }
    input, select {
      font-size: 12px;
      padding: 4px;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    select.status-tab, select.type-tab {
      border: none;
      color: #fff;
      font-weight: bold;
      text-align: center;
      padding: 6px;
      border-radius: 4px;
      appearance: none;
    }
    .Request\ Received { background-color: #42a5f5; }
    .Item\ Ordered { background-color: #ffd54f; color: #333; }
    .Delivered { background-color: #81c784; }
    .SSD\ Processing { background-color: #ffb74d; color: #333; }
    .In\ Storage { background-color: #9575cd; }
    .Returned\ to\ Supplier { background-color: #f06292; }
    .Loan { background-color: #4db6ac; }
    .Consignment { background-color: #7986cb; }
    .\-To\ be\ Updated\- { background-color: #b0bec5; color: #333; }
    .actions button {
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
      margin: 0 3px;
    }
    .equipment-popup {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 10px;
      font-size: 12px;
      max-width: 300px;
      display: none;
      z-index: 999;
    }
  </style>
</head>
<body>
  <h1>Equipment Request Tracker</h1>
  <input type="text" id="filterInput" placeholder="Search requests...">
  <div id="popup" class="equipment-popup"></div>
  <table>
    <thead>
      <tr>
        <th>Consultant</th>
        <th>Procedure</th>
        <th>Date</th>
        <th>Equipment</th>
        <th>Clinical Rep?</th>
        <th>Submitted By</th>
        <th>Received By</th>
        <th>Status</th>
        <th>Location</th>
        <th>Contact Rep</th>
        <th>Type</th>
        <th>PO</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="requestTable"></tbody>
  </table>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBOZvZGFijK2tQFYpwlGSBOgn3m_FSaBSc",
      authDomain: "equipment-whiteboard.firebaseapp.com",
      projectId: "equipment-whiteboard"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const popup = document.getElementById('popup');
    function showPopup(content, x, y) {
      popup.innerHTML = content;
      popup.style.left = x + 'px';
      popup.style.top = y + 'px';
      popup.style.display = 'block';
    }
    function hidePopup() { popup.style.display = 'none'; }
    document.addEventListener('click', () => hidePopup());

    const statusOptions = ['-To be Updated-', 'Request Received', 'Item Ordered', 'Delivered', 'SSD Processing', 'In Storage', 'Returned to Supplier'];
    const typeOptions = ['-To be Updated-', 'Loan', 'Consignment'];

    function createOption(value) {
      const opt = document.createElement('option');
      opt.value = value;
      opt.textContent = value;
      return opt;
    }

    function updateClass(selectEl, baseClass) {
      selectEl.className = baseClass + ' ' + selectEl.value;
    }

    function createRow(docId, data) {
      const tr = document.createElement('tr');
      const td = value => { const td = document.createElement('td'); td.textContent = value || ''; return td; };

      tr.dataset.search = `${data.consultant} ${data.plannedProcedure} ${data.location} ${data.status}`.toLowerCase();

      tr.appendChild(td(data.consultant));
      tr.appendChild(td(data.plannedProcedure));
      tr.appendChild(td(data.procedureDate));

      const equipTd = document.createElement('td');
      const viewLink = document.createElement('a');
      viewLink.href = "#";
      viewLink.textContent = "View List";
      viewLink.onclick = e => {
        e.preventDefault();
        e.stopPropagation();
        const list = (data.equipment || []).map(eq => `<li>${eq.name} (${eq.type}) x${eq.quantity}</li>`).join('');
        showPopup(`<strong>Equipment List:</strong><ul>${list}</ul>`, e.pageX + 10, e.pageY);
      };
      equipTd.appendChild(viewLink);
      tr.appendChild(equipTd);

      tr.appendChild(td(data.clinicalSupportRepNeeded ? 'Yes' : 'No'));
      tr.appendChild(td(data.submittedBy));

      const receivedTd = document.createElement('td');
      const receivedInput = document.createElement('input');
      receivedInput.value = data.receivedBy || '';
      receivedInput.onchange = () => db.collection("requests").doc(docId).update({ receivedBy: receivedInput.value });
      receivedTd.appendChild(receivedInput);
      tr.appendChild(receivedTd);

      const statusTd = document.createElement('td');
      const statusSel = document.createElement('select');
      statusSel.className = 'status-tab';
      statusOptions.forEach(opt => statusSel.appendChild(createOption(opt)));
      statusSel.value = data.status || '-To be Updated-';
      updateClass(statusSel, 'status-tab');
      statusSel.onchange = () => {
        updateClass(statusSel, 'status-tab');
        db.collection("requests").doc(docId).update({ status: statusSel.value });
      };
      statusTd.appendChild(statusSel);
      tr.appendChild(statusTd);

      const locationTd = document.createElement('td');
      const locationInput = document.createElement('input');
      locationInput.value = data.location || '';
      locationInput.onchange = () => db.collection("requests").doc(docId).update({ location: locationInput.value });
      locationTd.appendChild(locationInput);
      tr.appendChild(locationTd);

      const contactTd = document.createElement('td');
      const contactInput = document.createElement('input');
      contactInput.value = data.contactRep || '';
      contactInput.onchange = () => db.collection("requests").doc(docId).update({ contactRep: contactInput.value });
      contactTd.appendChild(contactInput);
      tr.appendChild(contactTd);

      const typeTd = document.createElement('td');
      const typeSel = document.createElement('select');
      typeSel.className = 'type-tab';
      typeOptions.forEach(opt => typeSel.appendChild(createOption(opt)));
      typeSel.value = data.type || '-To be Updated-';
      updateClass(typeSel, 'type-tab');
      typeSel.onchange = () => {
        updateClass(typeSel, 'type-tab');
        db.collection("requests").doc(docId).update({ type: typeSel.value });
      };
      typeTd.appendChild(typeSel);
      tr.appendChild(typeTd);

      const poTd = document.createElement('td');
      const poInput = document.createElement('input');
      poInput.value = data.poNumber || '';
      poInput.onchange = () => db.collection("requests").doc(docId).update({ poNumber: poInput.value });
      poTd.appendChild(poInput);
      tr.appendChild(poTd);

      const actionTd = document.createElement('td');
      actionTd.className = "actions";
      const delBtn = document.createElement('button');
      delBtn.textContent = 'ðŸ—‘ï¸';
      delBtn.onclick = () => {
        if (confirm("Delete this request?")) {
          db.collection("requests").doc(docId).delete();
        }
      };
      actionTd.appendChild(delBtn);
      tr.appendChild(actionTd);

      return tr;
    }

    db.collection("requests").orderBy("timestamp", "desc").onSnapshot(snapshot => {
      const table = document.getElementById("requestTable");
      table.innerHTML = "";
      snapshot.forEach(doc => {
        const row = createRow(doc.id, doc.data());
        table.appendChild(row);
      });
    });

    document.getElementById('filterInput').addEventListener('input', function () {
      const value = this.value.toLowerCase();
      document.querySelectorAll('#requestTable tr').forEach(row => {
        row.style.display = row.dataset.search.includes(value) ? '' : 'none';
      });
    });
  </script>
</body>
</html>
